INSTRUCTIONS:
Reshape the data so that each student has 4 rows each, with grades for 2021 and 2022 being in separate fields 

Calculate the average grade for each year for each student

Calculate the difference between the average grade of each student from 2021 to 2022

Categorize each student into the following 3:

Improvement (>0)

No change (=0)

Cause for concern (<0)

Filter out the data to leave only students with a ‘cause for concern’

Output the data 


CODE:

WITH CTE AS (
select STUDENT_ID, 
FIRST_NAME, 
LAST_NAME, 
GENDER, 
D_O_B,
REPLACE((SPLIT_PART(CATEGORY, '_', 1)), 'X', '') AS YEAR,
SPLIT_PART(CATEGORY, '_', 2) AS CATEGORY,
ACHIEVEMENT

from TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK21

UNPIVOT (ACHIEVEMENT FOR CATEGORY IN (
X2021_ATTAINMENT, 
X2021_EFFORT, 
X2021_ATTENDANCE, 
X2021_BEHAVIOUR, 
X2022_ATTAINMENT, 
X2022_EFFORT,
X2022_ATTENDANCE, 
X2022_BEHAVIOUR))),


CTE2 AS (
SELECT
STUDENT_ID,
YEAR,
AVG(ACHIEVEMENT) AS ACHIEVEMENT
FROM CTE
GROUP BY STUDENT_ID, YEAR),

FULLCTE AS (
SELECT
*
FROM CTE2
PIVOT (SUM(ACHIEVEMENT) FOR YEAR IN (2021, 2022))),

FULLCTE2 AS (
SELECT
A.STUDENT_ID,
FIRST_NAME, 
LAST_NAME, 
GENDER, 
D_O_B,
"2021",
"2022",
"2021"-"2022" AS DIFFERENCE
FROM FULLCTE AS A
INNER JOIN TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK21 AS B
ON A.STUDENT_ID = B.STUDENT_ID),

FULLCTE3 AS (
SELECT *,
CASE WHEN DIFFERENCE <0 THEN 'IMPROVEMENT'
WHEN DIFFERENCE =0 THEN 'NO CHANGE'
WHEN DIFFERENCE >0 THEN 'CAUSE FOR CONCERN'
END AS PROGRESS
FROM FULLCTE2)

SELECT *
FROM FULLCTE3
WHERE PROGRESS = 'CAUSE FOR CONCERN'
